<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic Tac Toe</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div id="game-board" style="display: none;">
        <h2 id="game-info">Connecting...</h2>
        <h3 id="opponent-info"></h3>
        <div class="board">
            <div class="cell" data-index="0"></div>
            <div class="cell" data-index="1"></div>
            <div class="cell" data-index="2"></div>
            <div class="cell" data-index="3"></div>
            <div class="cell" data-index="4"></div>
            <div class="cell" data-index="5"></div>
            <div class="cell" data-index="6"></div>
            <div class="cell" data-index="7"></div>
            <div class="cell" data-index="8"></div>
        </div>
    </div>
    <div id="connecting">
        <h2>Connecting...</h2>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        document.addEventListener('DOMContentLoaded', () => {
            const username = sessionStorage.getItem('username');
            if (username) {
                socket.emit('joinGameLobby', username);
                console.log('Joining game lobby:', username);
            } else {
                console.error('No username found in session storage.');
            }
        });

        socket.on('connect', () => {
            console.log('Connected to server.');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server.');
        });

        socket.on('startGame', (data) => {
            console.log('Start game received:', data);
            document.getElementById('connecting').style.display = 'none';
            document.getElementById('game-board').style.display = 'block';

            const gameId = data.gameId;
            const symbol = data.symbol;
            const turn = data.turn;
            const opponent = data.opponent;

            document.getElementById('game-info').innerText = `Game ID: ${gameId}, Your symbol: ${symbol}, Your turn: ${turn === sessionStorage.getItem('username')}`;
            document.getElementById('opponent-info').innerText = `Opponent: ${opponent}`;
            sessionStorage.setItem('gameId', gameId);
            sessionStorage.setItem('symbol', symbol);
            sessionStorage.setItem('turn', turn);
        });

        document.querySelectorAll('.cell').forEach(cell => {
            cell.addEventListener('click', () => {
                const gameId = sessionStorage.getItem('gameId');
                const symbol = sessionStorage.getItem('symbol');
                const cellIndex = cell.getAttribute('data-index');
                if (sessionStorage.getItem('turn') === sessionStorage.getItem('username')) {
                    if (cell.innerText === '') {
                        cell.innerText = symbol;
                        socket.emit('makeMove', { gameId, cellIndex, symbol });
                    }
                }
            });
        });

        socket.on('moveMade', (data) => {
            console.log('Move made received:', data);
            const { cellIndex, symbol, turn } = data;
            document.querySelector(`.cell[data-index='${cellIndex}']`).innerText = symbol;
            document.getElementById('game-info').innerText = `Your turn: ${turn === sessionStorage.getItem('username')}`;
            sessionStorage.setItem('turn', turn);
        });

        socket.on('gameOver', (data) => {
            console.log('Game over received:', data);
            alert(`Game over! Winner: ${data.winner}`);
            document.getElementById('game-board').style.display = 'none';
            document.getElementById('connecting').style.display = 'block';
        });
    </script>
</body>
</html>
