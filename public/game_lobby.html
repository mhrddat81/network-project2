<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Lobby</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        h1, h2 {
            text-align: center;
        }
        #userList, #ongoingGames {
            text-align: center;
            margin-top: 20px;
        }
        #matchRequest {
            text-align: center;
            display: none;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Welcome to the Game Lobby, <span id="username"></span></h1>
    <h2>Online Users</h2>
    <div id="userList">
        <!-- Online users will be dynamically added here -->
    </div>
    <div id="ongoingGames">
        <h2>Ongoing Games</h2>
        <!-- Ongoing games will be dynamically added here -->
    </div>
    <div id="matchRequest">
        <p id="matchRequestMessage"></p>
        <button id="acceptMatchRequest">Accept</button>
        <button id="rejectMatchRequest">Reject</button>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('username');
        document.getElementById('username').textContent = username;

        const socket = io();

        socket.emit('joinGameLobby', username);

        function updateUserList(users) {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            users.forEach(user => {
                if (user.username !== username) {
                    const usernameElement = document.createElement('div');
                    usernameElement.textContent = user.username;
                    usernameElement.style.cursor = 'pointer';
                    usernameElement.addEventListener('click', () => {
                        socket.emit('sendMatchRequest', { from: username, to: user.username });
                    });
                    userList.appendChild(usernameElement);
                }
            });
        }

        function updateOngoingGames(games) {
            const ongoingGames = document.getElementById('ongoingGames');
            ongoingGames.innerHTML = '<h2>Ongoing Games</h2>';
            games.forEach(game => {
                const gameElement = document.createElement('div');
                gameElement.textContent = `Game ID: ${game.id}, Players: ${game.player1} vs ${game.player2}`;
                ongoingGames.appendChild(gameElement);
            });
        }

        socket.on('updateUserList', (users) => {
            updateUserList(users);
        });

        socket.on('updateOngoingGames', (games) => {
            updateOngoingGames(games);
        });

        socket.on('logout', () => {
            window.location.href = '/';
        });

        socket.on('receiveMatchRequest', (data) => {
            const { from } = data;
            const matchRequest = document.getElementById('matchRequest');
            const matchRequestMessage = document.getElementById('matchRequestMessage');
            matchRequestMessage.textContent = `${from} has challenged you to a match!`;
            matchRequest.style.display = 'block';

            document.getElementById('acceptMatchRequest').onclick = () => {
                socket.emit('respondMatchRequest', { from, to: username, response: 'accept' });
                matchRequest.style.display = 'none';
            };

            document.getElementById('rejectMatchRequest').onclick = () => {
                socket.emit('respondMatchRequest', { from, to: username, response: 'reject' });
                matchRequest.style.display = 'none';
            };
        });

        socket.on('matchRequestResponse', (data) => {
            const { to, response } = data;
            if (response === 'reject') {
                alert(`${to} has rejected your match request.`);
            }
        });

        socket.on('startGame', (data) => {
            const { gameId, opponent, symbol, turn } = data;
            sessionStorage.setItem('gameId', gameId);
            sessionStorage.setItem('opponent', opponent);
            sessionStorage.setItem('symbol', symbol);
            sessionStorage.setItem('turn', turn);
            sessionStorage.setItem('username', username);
            window.location.href = `/game?gameId=${gameId}&opponent=${opponent}&username=${username}`;
        });
    </script>
</body>
</html>
